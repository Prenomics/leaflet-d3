import{hexbin as t}from"d3-hexbin";import{select as n,mouse as i,event as o}from"d3-selection";import{dispatch as e}from"d3-dispatch";import{scaleLinear as a}from"d3-scale";import{extent as r}from"d3-array";import"d3-transition";import"leaflet";L.HexbinLayer=L.SVG.extend({includes:L.Evented||L.Mixin.Events,options:{radius:12,opacity:.6,duration:200,scale:"linear",colorScaleExtent:[1,void 0],radiusScaleExtent:[1,void 0],colorDomain:null,radiusDomain:null,colorRange:["#f7fbff","#08306b"],radiusRange:[4,12],pointerEvents:"all"},initialize:function(n){L.setOptions(this,n),this._fn={lng:function(t){return t[0]},lat:function(t){return t[1]},colorValue:function(t){return t.length},radiusValue:function(t){return Number.MAX_VALUE},fill:function(t){var n="log"===this.options.scale?Math.log2(this._fn.colorValue(t)):this._fn.colorValue(t);return null!=n?this._scale.color(n):"none"}},this._scale={color:a(),radius:a()},this._dispatch=e("mouseover","mouseout","click"),this._hoverHandler=L.HexbinHoverHandler.none(),this._hexLayout=t().radius(this.options.radius).x((function(t){return t.point[0]})).y((function(t){return t.point[1]})),this._data=[],this._scale.color.range(this.options.colorRange).clamp(!0),this._scale.radius.range(this.options.radiusRange).clamp(!0)},onAdd:function(t){L.SVG.prototype.onAdd.call(this),this._map=t,t.on({moveend:this.redraw},this),this.redraw()},onRemove:function(t){L.SVG.prototype.onRemove.call(this),this._destroyContainer(),t.off({moveend:this.redraw},this),this._map=null,n("g.hexbin").remove()},_initContainer:function(){L.SVG.prototype._initContainer.call(this),this._d3Container=n(this._container).select("g")},_destroyContainer:function(){},redraw:function(){var t=this;if(t._map){var n=t._data.map((function(n){var i=t._fn.lng(n),o=t._fn.lat(n);return{o:n,point:t._project([i,o]),intensity:n[2]}})),i=this._d3Container.selectAll("g.hexbin").data([this._map.getZoom()],(function(t){return t})),o=i.enter().append("g").attr("class",(function(t){return"hexbin zoom-"+t})).merge(i);i.exit().remove(),this._createHexagons(o,n)}},_createHexagons:function(t,n){var i=this,o=i._map.getBounds(),e=i._map.getSize();o=o.pad(2*i.options.radius/Math.max(e.x,e.y));var a=i._hexLayout(n),r=i._getExtent(a,i._fn.colorValue,i.options.colorScaleExtent),s=i._getExtent(a,i._fn.radiusValue,i.options.radiusScaleExtent),l=this.options.colorDomain;null==l&&(l=i._linearlySpace(r[0],r[1],i._scale.color.range().length));var u=this.options.radiusDomain||s;i._scale.color.domain(l),i._scale.radius.domain(u),a=a.filter((function(t){return o.contains(i._map.layerPointToLatLng(L.point(t.x,t.y)))}));var c=t.selectAll("g.hexbin-container").data(a,(function(t){return t.x+":"+t.y}));c.select("path.hexbin-hexagon").transition().duration(i.options.duration).attr("fill",i._fn.fill.bind(i)).attr("fill-opacity",i.options.opacity).attr("stroke-opacity",i.options.opacity).attr("d",(function(t){return i._hexLayout.hexagon(i._scale.radius(i._fn.radiusValue.call(i,t)))}));var h=c.enter().append("g").attr("class","hexbin-container");h.append("path").attr("class","hexbin-hexagon").attr("transform",(function(t){return"translate("+t.x+","+t.y+")"})).attr("d",(function(t){return i._hexLayout.hexagon(i._scale.radius.range()[0])})).attr("fill",i._fn.fill.bind(i)).attr("fill-opacity",.01).attr("stroke-opacity",.01).transition().duration(i.options.duration).attr("fill-opacity",i.options.opacity).attr("stroke-opacity",i.options.opacity).attr("d",(function(t){return i._hexLayout.hexagon(i._scale.radius(i._fn.radiusValue.call(i,t)))})),h.append("path").attr("class","hexbin-grid").attr("transform",(function(t){return"translate("+t.x+","+t.y+")"})).attr("d",(function(t){return i._hexLayout.hexagon(i.options.radius)})).attr("fill","none").attr("stroke","none").style("pointer-events",i.options.pointerEvents).merge(c.select("path.hexbin-grid")).on("mouseover",(function(t,n){i._hoverHandler.mouseover.call(this,i,t,n),i._dispatch.call("mouseover",this,t,n)})).on("mouseout",(function(t,n){i._dispatch.call("mouseout",this,t,n),i._hoverHandler.mouseout.call(this,i,t,n)})).on("click",(function(t,n){i._dispatch.call("click",this,t,n)}));var d=c.exit();d.select("path.hexbin-hexagon").transition().duration(i.options.duration).attr("fill-opacity",0).attr("stroke-opacity",0).attr("d",(function(t){return i._hexLayout.hexagon(0)})),d.transition().duration(i.options.duration).remove()},_getExtent:function(t,n,i){var o=r(t,n.bind(this));return null==o[0]&&(o[0]=0),null==o[1]&&(o[1]=0),null!=i[0]&&(o[0]=i[0]),null!=i[1]&&(o[1]=i[1]),o},_project:function(t){var n=this._map.latLngToLayerPoint([t[1],t[0]]);return[n.x,n.y]},_getBounds:function(t){if(null==t||t.length<1)return{min:[0,0],max:[0,0]};var n=[[999,999],[-999,-999]];return t.forEach((function(t){var i=t.point[0],o=t.point[1];n[0][0]=Math.min(n[0][0],i),n[0][1]=Math.min(n[0][1],o),n[1][0]=Math.max(n[1][0],i),n[1][1]=Math.max(n[1][1],o)})),{min:n[0],max:n[1]}},_linearlySpace:function(t,n,i){var o=new Array(i);t=t?"log"===this.options.scale?Math.log2(t):t:0;for(var e=(("log"===this.options.scale?Math.log2(n):n)-t)/Math.max(i-1,1),a=0;a<i;++a)o[a]=t+a*e;return o},radius:function(t){return arguments.length?(this.options.radius=t,this._hexLayout.radius(t),this):this.options.radius},opacity:function(t){return arguments.length?(this.options.opacity=t,this):this.options.opacity},duration:function(t){return arguments.length?(this.options.duration=t,this):this.options.duration},colorScaleExtent:function(t){return arguments.length?(this.options.colorScaleExtent=t,this):this.options.colorScaleExtent},radiusScaleExtent:function(t){return arguments.length?(this.options.radiusScaleExtent=t,this):this.options.radiusScaleExtent},colorRange:function(t){return arguments.length?(this.options.colorRange=t,this._scale.color.range(t),this):this.options.colorRange},radiusRange:function(t){return arguments.length?(this.options.radiusRange=t,this._scale.radius.range(t),this):this.options.radiusRange},colorScale:function(t){return arguments.length?(this._scale.color=t,this):this._scale.color},radiusScale:function(t){return arguments.length?(this._scale.radius=t,this):this._scale.radius},lng:function(t){return arguments.length?(this._fn.lng=t,this):this._fn.lng},lat:function(t){return arguments.length?(this._fn.lat=t,this):this._fn.lat},colorValue:function(t){return arguments.length?(this._fn.colorValue=t,this):this._fn.colorValue},radiusValue:function(t){return arguments.length?(this._fn.radiusValue=t,this):this._fn.radiusValue},fill:function(t){return arguments.length?(this._fn.fill=t,this):this._fn.fill},data:function(t){return arguments.length?(this._data=null!=t?t:[],this.redraw(),this):this._data},dispatch:function(){return this._dispatch},hoverHandler:function(t){return arguments.length?(this._hoverHandler=null!=t?t:L.HexbinHoverHandler.none(),this.redraw(),this):this._hoverHandler},getLatLngs:function(){var t=this;return this._data.map((function(n){return L.latLng(t.options.lat(n),t.options.lng(n))}))},toGeoJSON:function(){return L.GeoJSON.getFeature(this,{type:"LineString",coordinates:L.GeoJSON.latLngsToCoords(this.getLatLngs(),0)})}}),L.HexbinHoverHandler={tooltip:function(t){null==(t=t||{}).tooltipContent&&(t.tooltipContent=function(n){var i=n.reduce((function(t,n){return t+=n.intensity}),0);return t.transformation&&(i=t.transformation(i)),i});var e=n(".map.leaflet-container").append("div").attr("class","hexbin-tooltip").style("z-index",9999999).style("pointer-events","none").style("visibility","hidden").style("position","fixed");return e.append("div").attr("class","tooltip-content"),{mouseover:function(n,a){var r=i(this),s=null;if(null!=e._groups&&e._groups.length>0&&e._groups[0].length>0&&(s=e._groups[0][0]),s){e.style("visibility","visible").html(t.tooltipContent(a,n));var l=s.clientHeight,u=s.clientWidth;e.style("top",o.clientY-r[1]-l-16+"px").style("left",o.clientX-r[0]-u/2+"px")}},mouseout:function(t,n){e.style("visibility","hidden").html()}}},resizeFill:function(){return{mouseover:function(t,i){n(this.parentNode).select("path.hexbin-hexagon").attr("d",(function(n){return t._hexLayout.hexagon(t.options.radius)}))},mouseout:function(t,i){n(this.parentNode).select("path.hexbin-hexagon").attr("d",(function(n){return t._hexLayout.hexagon(t._scale.radius(t._fn.radiusValue.call(t,n)))}))}}},resizeScale:function(t){return null==(t=t||{}).radiusScale&&(t.radiusScale=.5),{mouseover:function(i,o){n(this.parentNode).select("path.hexbin-hexagon").attr("d",(function(n){return i._hexLayout.hexagon(i._scale.radius.range()[1]*(1+t.radiusScale))}))},mouseout:function(t,i){n(this.parentNode).select("path.hexbin-hexagon").attr("d",(function(n){return t._hexLayout.hexagon(t._scale.radius(t._fn.radiusValue.call(t,n)))}))}}},compound:function(t){return null==(t=t||{}).handlers&&(t.handlers=[L.HexbinHoverHandler.none()]),{mouseover:function(n,i){var o=this;t.handlers.forEach((function(t){t.mouseover.call(o,n,i)}))},mouseout:function(n,i){var o=this;t.handlers.forEach((function(t){t.mouseout.call(o,n,i)}))}}},none:function(){return{mouseover:function(){},mouseout:function(){}}}},L.hexbinLayer=function(t){return new L.HexbinLayer(t)};
//# sourceMappingURL=main.js.map
