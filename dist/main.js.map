{"version":3,"file":"main.js","sources":["../src/HexbinLayer.js"],"sourcesContent":["import {hexbin} from 'd3-hexbin';\nimport {event, mouse, select} from 'd3-selection';\nimport {dispatch} from 'd3-dispatch';\nimport {scaleLinear} from 'd3-scale';\nimport {extent} from 'd3-array';\nimport 'd3-transition';\nimport 'leaflet';\n\n/**\n * L is defined by the Leaflet library, see git://github.com/Leaflet/Leaflet.git for documentation\n * We extend L.SVG to take advantage of built-in zoom animations.\n */\nL.HexbinLayer = L.SVG.extend({\n\tincludes: L.Evented || L.Mixin.Events,\n\n\t/**\n\t * Default options\n\t */\n\toptions: {\n\t\tradius: 12,\n\t\topacity: 0.6,\n\t\tduration: 200,\n\n\t\tscale: 'linear',\n\t\tcolorScaleExtent: [1, undefined],\n\t\tradiusScaleExtent: [1, undefined],\n\t\tcolorDomain: null,\n\t\tradiusDomain: null,\n\t\tcolorRange: ['#f7fbff', '#08306b'],\n\t\tradiusRange: [4, 12],\n\n\t\tpointerEvents: 'all'\n\t},\n\n\n\t/**\n\t * Standard Leaflet initialize function, accepting an options argument provided by the\n\t * user when they create the layer\n\t * @param options Options object where the options override the defaults\n\t */\n\tinitialize: function (options) {\n\t\tL.setOptions(this, options);\n\n\t\t// Set up the various overrideable functions\n\t\tthis._fn = {\n\t\t\tlng: function (d) {\n\t\t\t\treturn d[0];\n\t\t\t},\n\t\t\tlat: function (d) {\n\t\t\t\treturn d[1];\n\t\t\t},\n\t\t\tcolorValue: function (d) {\n\t\t\t\treturn d.length;\n\t\t\t},\n\t\t\tradiusValue: function (d) {\n\t\t\t\treturn Number.MAX_VALUE;\n\t\t\t},\n\n\t\t\tfill: function (d) {\n\t\t\t\tvar val = this.options.scale === 'log' ? Math.log2(this._fn.colorValue(d)) : this._fn.colorValue(d);\n\t\t\t\treturn null != val ? this._scale.color(val) : 'none';\n\t\t\t}\n\t\t};\n\n\t\t// Set up the customizable scale\n\t\tthis._scale = {\n\t\t\tcolor: scaleLinear(),\n\t\t\tradius: scaleLinear()\n\t\t};\n\n\t\t// Set up the Dispatcher for managing events and callbacks\n\t\tthis._dispatch = dispatch('mouseover', 'mouseout', 'click');\n\n\t\t// Set up the default hover handler\n\t\tthis._hoverHandler = L.HexbinHoverHandler.none();\n\n\t\t// Create the hex layout\n\t\tthis._hexLayout = hexbin()\n\t\t\t.radius(this.options.radius)\n\t\t\t.x(function (d) {\n\t\t\t\treturn d.point[0];\n\t\t\t})\n\t\t\t.y(function (d) {\n\t\t\t\treturn d.point[1];\n\t\t\t});\n\n\t\t// Initialize the data array to be empty\n\t\tthis._data = [];\n\n\t\tthis._scale.color\n\t\t\t.range(this.options.colorRange)\n\t\t\t.clamp(true);\n\n\t\tthis._scale.radius\n\t\t\t.range(this.options.radiusRange)\n\t\t\t.clamp(true);\n\n\t},\n\n\t/**\n\t * Callback made by Leaflet when the layer is added to the map\n\t * @param map Reference to the map to which this layer has been added\n\t */\n\tonAdd: function (map) {\n\n\t\tL.SVG.prototype.onAdd.call(this);\n\n\t\t// Store a reference to the map for later use\n\t\tthis._map = map;\n\n\t\t// Redraw on moveend\n\t\tmap.on({'moveend': this.redraw}, this);\n\n\t\t// Initial draw\n\t\tthis.redraw();\n\n\t},\n\n\t/**\n\t * Callback made by Leaflet when the layer is removed from the map\n\t * @param map Reference to the map from which this layer is being removed\n\t */\n\tonRemove: function (map) {\n\n\t\tL.SVG.prototype.onRemove.call(this);\n\n\t\t// Destroy the svg container\n\t\tthis._destroyContainer();\n\n\t\t// Remove events\n\t\tmap.off({'moveend': this.redraw}, this);\n\n\t\tthis._map = null;\n\n\t\tselect('g.hexbin').remove();\n\n\t\t// Explicitly will leave the data array alone in case the layer will be shown again\n\t\t//this._data = [];\n\n\t},\n\n\t/**\n\t * Create the SVG container for the hexbins\n\t * @private\n\t */\n\t_initContainer: function () {\n\n\t\tL.SVG.prototype._initContainer.call(this);\n\t\tthis._d3Container = select(this._container).select('g');\n\t},\n\n\t/**\n\t * Clean up the svg container\n\t * @private\n\t */\n\t_destroyContainer: function () {\n\n\t\t// Don't do anything\n\n\t},\n\n\t/**\n\t * (Re)draws the hexbins data on the container\n\t * @private\n\t */\n\tredraw: function () {\n\t\tvar that = this;\n\n\t\tif (!that._map) {\n\t\t\treturn;\n\t\t}\n\n\t\t// Generate the mapped version of the data\n\t\tvar data = that._data.map(function (d) {\n\t\t\tvar lng = that._fn.lng(d);\n\t\t\tvar lat = that._fn.lat(d);\n\n\t\t\tvar point = that._project([lng, lat]);\n\t\t\treturn {o: d, point: point, intensity: d[2]};\n\t\t});\n\n\t\t// Select the hex group for the current zoom level. This has\n\t\t// the effect of recreating the group if the zoom level has changed\n\t\tvar join = this._d3Container.selectAll('g.hexbin')\n\t\t\t.data([this._map.getZoom()], function (d) {\n\t\t\t\treturn d;\n\t\t\t});\n\n\t\t// enter\n\t\tvar enter = join.enter().append('g')\n\t\t\t.attr('class', function (d) {\n\t\t\t\treturn 'hexbin zoom-' + d;\n\t\t\t});\n\n\t\t// enter + update\n\t\tvar enterUpdate = enter.merge(join);\n\n\t\t// exit\n\t\tjoin.exit().remove();\n\n\t\t// add the hexagons to the select\n\t\tthis._createHexagons(enterUpdate, data);\n\n\t},\n\n\t_createHexagons: function (g, data) {\n\t\tvar that = this;\n\n\t\t// Create the bins using the hexbin layout\n\n\t\t// Generate the map bounds (to be used to filter the hexes to what is visible)\n\t\tvar bounds = that._map.getBounds();\n\t\tvar size = that._map.getSize();\n\t\tbounds = bounds.pad(that.options.radius * 2 / Math.max(size.x, size.y));\n\n\t\tvar bins = that._hexLayout(data);\n\n\t\t// Derive the extents of the data values for each dimension\n\t\tvar colorExtent = that._getExtent(bins, that._fn.colorValue, that.options.colorScaleExtent);\n\t\tvar radiusExtent = that._getExtent(bins, that._fn.radiusValue, that.options.radiusScaleExtent);\n\n\t\t// Match the domain cardinality to that of the color range, to allow for a polylinear scale\n\t\tvar colorDomain = this.options.colorDomain;\n\t\tif (null == colorDomain) {\n\t\t\tcolorDomain = that._linearlySpace(colorExtent[0], colorExtent[1], that._scale.color.range().length);\n\t\t}\n\t\tvar radiusDomain = this.options.radiusDomain || radiusExtent;\n\n\t\t// Set the scale domains\n\t\tthat._scale.color.domain(colorDomain);\n\t\tthat._scale.radius.domain(radiusDomain);\n\n\n\t\t/*\n\t\t * Join\n\t\t *    Join the Hexagons to the data\n\t\t *    Use a deterministic id for tracking bins based on position\n\t\t */\n\t\tbins = bins.filter(function (d) {\n\t\t\treturn bounds.contains(that._map.layerPointToLatLng(L.point(d.x, d.y)));\n\t\t});\n\t\tvar join = g.selectAll('g.hexbin-container')\n\t\t\t.data(bins, function (d) {\n\t\t\t\treturn d.x + ':' + d.y;\n\t\t\t});\n\n\n\t\t/*\n\t\t * Update\n\t\t *    Set the fill and opacity on a transition\n\t\t *    opacity is re-applied in case the enter transition was cancelled\n\t\t *    the path is applied as well to resize the bins\n\t\t */\n\t\tjoin.select('path.hexbin-hexagon').transition().duration(that.options.duration)\n\t\t\t.attr('fill', that._fn.fill.bind(that))\n\t\t\t.attr('fill-opacity', that.options.opacity)\n\t\t\t.attr('stroke-opacity', that.options.opacity)\n\t\t\t.attr('d', function (d) {\n\t\t\t\treturn that._hexLayout.hexagon(that._scale.radius(that._fn.radiusValue.call(that, d)));\n\t\t\t});\n\n\n\t\t/*\n\t\t * Enter\n\t\t *    Establish the path, size, fill, and the initial opacity\n\t\t *    Transition to the final opacity and size\n\t\t */\n\t\tvar enter = join.enter().append('g').attr('class', 'hexbin-container');\n\n\t\tenter.append('path').attr('class', 'hexbin-hexagon')\n\t\t\t.attr('transform', function (d) {\n\t\t\t\treturn 'translate(' + d.x + ',' + d.y + ')';\n\t\t\t})\n\t\t\t.attr('d', function (d) {\n\t\t\t\treturn that._hexLayout.hexagon(that._scale.radius.range()[0]);\n\t\t\t})\n\t\t\t.attr('fill', that._fn.fill.bind(that))\n\t\t\t.attr('fill-opacity', 0.01)\n\t\t\t.attr('stroke-opacity', 0.01)\n\t\t\t.transition().duration(that.options.duration)\n\t\t\t.attr('fill-opacity', that.options.opacity)\n\t\t\t.attr('stroke-opacity', that.options.opacity)\n\t\t\t.attr('d', function (d) {\n\t\t\t\treturn that._hexLayout.hexagon(that._scale.radius(that._fn.radiusValue.call(that, d)));\n\t\t\t});\n\n\t\t// Grid\n\t\tvar gridEnter = enter.append('path').attr('class', 'hexbin-grid')\n\t\t\t.attr('transform', function (d) {\n\t\t\t\treturn 'translate(' + d.x + ',' + d.y + ')';\n\t\t\t})\n\t\t\t.attr('d', function (d) {\n\t\t\t\treturn that._hexLayout.hexagon(that.options.radius);\n\t\t\t})\n\t\t\t.attr('fill', 'none')\n\t\t\t.attr('stroke', 'none')\n\t\t\t.style('pointer-events', that.options.pointerEvents);\n\n\t\t// Grid enter-update\n\t\tgridEnter.merge(join.select('path.hexbin-grid'))\n\t\t\t.on('mouseover', function (d, i) {\n\t\t\t\tthat._hoverHandler.mouseover.call(this, that, d, i);\n\t\t\t\tthat._dispatch.call('mouseover', this, d, i);\n\t\t\t})\n\t\t\t.on('mouseout', function (d, i) {\n\t\t\t\tthat._dispatch.call('mouseout', this, d, i);\n\t\t\t\tthat._hoverHandler.mouseout.call(this, that, d, i);\n\t\t\t})\n\t\t\t.on('click', function (d, i) {\n\t\t\t\tthat._dispatch.call('click', this, d, i);\n\t\t\t});\n\n\n\t\t// Exit\n\t\tvar exit = join.exit();\n\n\t\texit.select('path.hexbin-hexagon')\n\t\t\t.transition().duration(that.options.duration)\n\t\t\t.attr('fill-opacity', 0)\n\t\t\t.attr('stroke-opacity', 0)\n\t\t\t.attr('d', function (d) {\n\t\t\t\treturn that._hexLayout.hexagon(0);\n\t\t\t});\n\n\t\texit.transition().duration(that.options.duration)\n\t\t\t.remove();\n\n\t},\n\n\t_getExtent: function (bins, valueFn, scaleExtent) {\n\n\t\t// Determine the extent of the values\n\t\tvar _extent = extent(bins, valueFn.bind(this));\n\n\t\t// If either's null, initialize them to 0\n\t\tif (null == _extent[0]) _extent[0] = 0;\n\t\tif (null == _extent[1]) _extent[1] = 0;\n\n\t\t// Now apply the optional clipping of the extent\n\t\tif (null != scaleExtent[0]) _extent[0] = scaleExtent[0];\n\t\tif (null != scaleExtent[1]) _extent[1] = scaleExtent[1];\n\n\t\treturn _extent;\n\n\t},\n\n\t_project: function (coord) {\n\t\tvar point = this._map.latLngToLayerPoint([coord[1], coord[0]]);\n\t\treturn [point.x, point.y];\n\t},\n\n\t_getBounds: function (data) {\n\t\tif (null == data || data.length < 1) {\n\t\t\treturn {min: [0, 0], max: [0, 0]};\n\t\t}\n\n\t\t// bounds is [[min long, min lat], [max long, max lat]]\n\t\tvar bounds = [[999, 999], [-999, -999]];\n\n\t\tdata.forEach(function (element) {\n\t\t\tvar x = element.point[0];\n\t\t\tvar y = element.point[1];\n\n\t\t\tbounds[0][0] = Math.min(bounds[0][0], x);\n\t\t\tbounds[0][1] = Math.min(bounds[0][1], y);\n\t\t\tbounds[1][0] = Math.max(bounds[1][0], x);\n\t\t\tbounds[1][1] = Math.max(bounds[1][1], y);\n\t\t});\n\n\t\treturn {min: bounds[0], max: bounds[1]};\n\t},\n\n\t_linearlySpace: function (from, to, length) {\n\t\tvar arr = new Array(length);\n\t\tfrom = from ? (this.options.scale === 'log' ? Math.log2(from) : from) : 0;\n\t\tvar step =\n\t\t\t((this.options.scale === 'log' ? Math.log2(to) : to) - from) / Math.max(length - 1, 1);\n\n\t\tfor (var i = 0; i < length; ++i) {\n\t\t\tarr[i] = from + i * step;\n\t\t}\n\n\t\treturn arr;\n\t},\n\n\n\t// ------------------------------------\n\t// Public API\n\t// ------------------------------------\n\n\tradius: function (v) {\n\t\tif (!arguments.length) {\n\t\t\treturn this.options.radius;\n\t\t}\n\n\t\tthis.options.radius = v;\n\t\tthis._hexLayout.radius(v);\n\n\t\treturn this;\n\t},\n\n\topacity: function (v) {\n\t\tif (!arguments.length) {\n\t\t\treturn this.options.opacity;\n\t\t}\n\t\tthis.options.opacity = v;\n\n\t\treturn this;\n\t},\n\n\tduration: function (v) {\n\t\tif (!arguments.length) {\n\t\t\treturn this.options.duration;\n\t\t}\n\t\tthis.options.duration = v;\n\n\t\treturn this;\n\t},\n\n\tcolorScaleExtent: function (v) {\n\t\tif (!arguments.length) {\n\t\t\treturn this.options.colorScaleExtent;\n\t\t}\n\t\tthis.options.colorScaleExtent = v;\n\n\t\treturn this;\n\t},\n\n\tradiusScaleExtent: function (v) {\n\t\tif (!arguments.length) {\n\t\t\treturn this.options.radiusScaleExtent;\n\t\t}\n\t\tthis.options.radiusScaleExtent = v;\n\n\t\treturn this;\n\t},\n\n\tcolorRange: function (v) {\n\t\tif (!arguments.length) {\n\t\t\treturn this.options.colorRange;\n\t\t}\n\t\tthis.options.colorRange = v;\n\t\tthis._scale.color.range(v);\n\n\t\treturn this;\n\t},\n\n\tradiusRange: function (v) {\n\t\tif (!arguments.length) {\n\t\t\treturn this.options.radiusRange;\n\t\t}\n\t\tthis.options.radiusRange = v;\n\t\tthis._scale.radius.range(v);\n\n\t\treturn this;\n\t},\n\n\tcolorScale: function (v) {\n\t\tif (!arguments.length) {\n\t\t\treturn this._scale.color;\n\t\t}\n\t\tthis._scale.color = v;\n\n\t\treturn this;\n\t},\n\n\tradiusScale: function (v) {\n\t\tif (!arguments.length) {\n\t\t\treturn this._scale.radius;\n\t\t}\n\t\tthis._scale.radius = v;\n\n\t\treturn this;\n\t},\n\n\tlng: function (v) {\n\t\tif (!arguments.length) {\n\t\t\treturn this._fn.lng;\n\t\t}\n\t\tthis._fn.lng = v;\n\n\t\treturn this;\n\t},\n\n\tlat: function (v) {\n\t\tif (!arguments.length) {\n\t\t\treturn this._fn.lat;\n\t\t}\n\t\tthis._fn.lat = v;\n\n\t\treturn this;\n\t},\n\n\tcolorValue: function (v) {\n\t\tif (!arguments.length) {\n\t\t\treturn this._fn.colorValue;\n\t\t}\n\t\tthis._fn.colorValue = v;\n\n\t\treturn this;\n\t},\n\n\tradiusValue: function (v) {\n\t\tif (!arguments.length) {\n\t\t\treturn this._fn.radiusValue;\n\t\t}\n\t\tthis._fn.radiusValue = v;\n\n\t\treturn this;\n\t},\n\n\tfill: function (v) {\n\t\tif (!arguments.length) {\n\t\t\treturn this._fn.fill;\n\t\t}\n\t\tthis._fn.fill = v;\n\n\t\treturn this;\n\t},\n\n\tdata: function (v) {\n\t\tif (!arguments.length) {\n\t\t\treturn this._data;\n\t\t}\n\t\tthis._data = (null != v) ? v : [];\n\n\t\tthis.redraw();\n\n\t\treturn this;\n\t},\n\n\t/*\n\t * Getter for the event dispatcher\n\t */\n\tdispatch: function () {\n\t\treturn this._dispatch;\n\t},\n\n\thoverHandler: function (v) {\n\t\tif (!arguments.length) {\n\t\t\treturn this._hoverHandler;\n\t\t}\n\t\tthis._hoverHandler = (null != v) ? v : L.HexbinHoverHandler.none();\n\n\t\tthis.redraw();\n\n\t\treturn this;\n\t},\n\n\t/*\n\t * Returns an array of the points in the path, or nested arrays of points in case of multi-polyline.\n\t */\n\tgetLatLngs: function () {\n\t\tvar that = this;\n\n\t\t// Map the data into an array of latLngs using the configured lat/lng accessors\n\t\treturn this._data.map(function (d) {\n\t\t\treturn L.latLng(that.options.lat(d), that.options.lng(d));\n\t\t});\n\t},\n\n\t/*\n\t * Get path geometry as GeoJSON\n\t */\n\ttoGeoJSON: function () {\n\t\treturn L.GeoJSON.getFeature(this, {\n\t\t\ttype: 'LineString',\n\t\t\tcoordinates: L.GeoJSON.latLngsToCoords(this.getLatLngs(), 0)\n\t\t});\n\t}\n\n});\n\n// Hover Handlers modify the hexagon and can be combined\nL.HexbinHoverHandler = {\n\n\ttooltip: function (options) {\n\n\t\t// merge options with defaults\n\t\toptions = options || {};\n\t\tif (null == options.tooltipContent) {\n\t\t\toptions.tooltipContent = function(d) {\n\t\t\t\tvar value = d.reduce(function(acc, curr) {\n\t\t\t\t\tacc += curr.intensity;\n\t\t\t\t\treturn acc;\n\t\t\t\t}, 0);\n\n\t\t\t\tif (options.transformation) {\n\t\t\t\t\tvalue = options.transformation(value);\n\t\t\t\t}\n\n\t\t\t\treturn value;\n\t\t\t};\n\t\t}\n\n\t\t// Generate the tooltip\n\t\tvar tooltip = select('.map.leaflet-container')\n\t\t\t.append('div')\n\t\t\t.attr('class', 'hexbin-tooltip')\n\t\t\t.style('z-index', 9999999)\n\t\t\t.style('pointer-events', 'none')\n\t\t\t.style('visibility', 'hidden')\n\t\t\t.style('position', 'fixed');\n\n\t\ttooltip.append('div').attr('class', 'tooltip-content');\n\n\t\t// return the handler instance\n\t\treturn {\n\t\t\tmouseover: function (hexLayer, data) {\n\t\t\t\tvar gCoords = mouse(this);\n\n\t\t\t\tvar div = null;\n\t\t\t\tif (\n\t\t\t\t\tnull != tooltip._groups &&\n\t\t\t\t\ttooltip._groups.length > 0 &&\n\t\t\t\t\ttooltip._groups[0].length > 0\n\t\t\t\t) {\n\t\t\t\t\tdiv = tooltip._groups[0][0];\n\t\t\t\t}\n\n\t\t\t\tif (!div) return;\n\n\t\t\t\ttooltip.style('visibility', 'visible').html(options.tooltipContent(data, hexLayer));\n\n\t\t\t\tvar h = div.clientHeight;\n\t\t\t\tvar w = div.clientWidth;\n\n\t\t\t\ttooltip\n\t\t\t\t\t.style('top', '' + (event.clientY - gCoords[1] - h - 16) + 'px')\n\t\t\t\t\t.style('left', '' + (event.clientX - gCoords[0] - w / 2) + 'px');\n\n\t\t\t},\n\t\t\tmouseout: function (hexLayer, data) {\n\t\t\t\ttooltip\n\t\t\t\t\t.style('visibility', 'hidden')\n\t\t\t\t\t.html();\n\t\t\t}\n\t\t};\n\n\t},\n\n\tresizeFill: function () {\n\n\t\t// return the handler instance\n\t\treturn {\n\t\t\tmouseover: function (hexLayer, data) {\n\t\t\t\tvar o = select(this.parentNode);\n\t\t\t\to.select('path.hexbin-hexagon')\n\t\t\t\t\t.attr('d', function (d) {\n\t\t\t\t\t\treturn hexLayer._hexLayout.hexagon(hexLayer.options.radius);\n\t\t\t\t\t});\n\t\t\t},\n\t\t\tmouseout: function (hexLayer, data) {\n\t\t\t\tvar o = select(this.parentNode);\n\t\t\t\to.select('path.hexbin-hexagon')\n\t\t\t\t\t.attr('d', function (d) {\n\t\t\t\t\t\treturn hexLayer._hexLayout.hexagon(hexLayer._scale.radius(hexLayer._fn.radiusValue.call(hexLayer, d)));\n\t\t\t\t\t});\n\t\t\t}\n\t\t};\n\n\t},\n\n\tresizeScale: function (options) {\n\n\t\t// merge options with defaults\n\t\toptions = options || {};\n\t\tif (null == options.radiusScale) options.radiusScale = 0.5;\n\n\t\t// return the handler instance\n\t\treturn {\n\t\t\tmouseover: function (hexLayer, data) {\n\t\t\t\tvar o = select(this.parentNode);\n\t\t\t\to.select('path.hexbin-hexagon')\n\t\t\t\t\t.attr('d', function (d) {\n\t\t\t\t\t\treturn hexLayer._hexLayout.hexagon(hexLayer._scale.radius.range()[1] * (1 + options.radiusScale));\n\t\t\t\t\t});\n\t\t\t},\n\t\t\tmouseout: function (hexLayer, data) {\n\t\t\t\tvar o = select(this.parentNode);\n\t\t\t\to.select('path.hexbin-hexagon')\n\t\t\t\t\t.attr('d', function (d) {\n\t\t\t\t\t\treturn hexLayer._hexLayout.hexagon(hexLayer._scale.radius(hexLayer._fn.radiusValue.call(hexLayer, d)));\n\t\t\t\t\t});\n\t\t\t}\n\t\t};\n\n\t},\n\n\tcompound: function (options) {\n\n\t\toptions = options || {};\n\t\tif (null == options.handlers) options.handlers = [L.HexbinHoverHandler.none()];\n\n\t\treturn {\n\t\t\tmouseover: function (hexLayer, data) {\n\t\t\t\tvar that = this;\n\t\t\t\toptions.handlers.forEach(function (h) {\n\t\t\t\t\th.mouseover.call(that, hexLayer, data);\n\t\t\t\t});\n\t\t\t},\n\t\t\tmouseout: function (hexLayer, data) {\n\t\t\t\tvar that = this;\n\t\t\t\toptions.handlers.forEach(function (h) {\n\t\t\t\t\th.mouseout.call(that, hexLayer, data);\n\t\t\t\t});\n\t\t\t}\n\t\t};\n\n\t},\n\n\tnone: function () {\n\t\treturn {\n\t\t\tmouseover: function () {\n\t\t\t},\n\t\t\tmouseout: function () {\n\t\t\t}\n\t\t};\n\t}\n};\n\nL.hexbinLayer = function (options) {\n\treturn new L.HexbinLayer(options);\n};\n"],"names":["L","HexbinLayer","SVG","extend","includes","Evented","Mixin","Events","options","radius","opacity","duration","scale","colorScaleExtent","undefined","radiusScaleExtent","colorDomain","radiusDomain","colorRange","radiusRange","pointerEvents","initialize","setOptions","this","_fn","lng","d","lat","colorValue","length","radiusValue","Number","MAX_VALUE","fill","val","Math","log2","_scale","color","scaleLinear","_dispatch","dispatch","_hoverHandler","HexbinHoverHandler","none","_hexLayout","hexbin","x","point","y","_data","range","clamp","onAdd","map","prototype","call","_map","on","moveend","redraw","onRemove","_destroyContainer","off","select","remove","_initContainer","_d3Container","_container","that","data","o","_project","intensity","join","selectAll","getZoom","enterUpdate","enter","append","attr","merge","exit","_createHexagons","g","bounds","getBounds","size","getSize","pad","max","bins","colorExtent","_getExtent","radiusExtent","_linearlySpace","domain","filter","contains","layerPointToLatLng","transition","bind","hexagon","style","i","mouseover","mouseout","valueFn","scaleExtent","_extent","extent","coord","latLngToLayerPoint","_getBounds","min","forEach","element","from","to","arr","Array","step","v","arguments","colorScale","radiusScale","hoverHandler","getLatLngs","latLng","toGeoJSON","GeoJSON","getFeature","type","coordinates","latLngsToCoords","tooltip","tooltipContent","value","reduce","acc","curr","transformation","hexLayer","gCoords","mouse","div","_groups","html","h","clientHeight","w","clientWidth","event","clientY","clientX","resizeFill","parentNode","resizeScale","compound","handlers","hexbinLayer"],"mappings":"qPAYAA,EAAEC,YAAcD,EAAEE,IAAIC,OAAO,CAC5BC,SAAUJ,EAAEK,SAAWL,EAAEM,MAAMC,OAK/BC,QAAS,CACRC,OAAQ,GACRC,QAAS,GACTC,SAAU,IAEVC,MAAO,SACPC,iBAAkB,CAAC,OAAGC,GACtBC,kBAAmB,CAAC,OAAGD,GACvBE,YAAa,KACbC,aAAc,KACdC,WAAY,CAAC,UAAW,WACxBC,YAAa,CAAC,EAAG,IAEjBC,cAAe,OAShBC,WAAY,SAAUb,GACrBR,EAAEsB,WAAWC,KAAMf,GAGnBe,KAAKC,IAAM,CACVC,IAAK,SAAUC,GACd,OAAOA,EAAE,IAEVC,IAAK,SAAUD,GACd,OAAOA,EAAE,IAEVE,WAAY,SAAUF,GACrB,OAAOA,EAAEG,QAEVC,YAAa,SAAUJ,GACtB,OAAOK,OAAOC,WAGfC,KAAM,SAAUP,GACf,IAAIQ,EAA6B,QAAvBX,KAAKf,QAAQI,MAAkBuB,KAAKC,KAAKb,KAAKC,IAAII,WAAWF,IAAMH,KAAKC,IAAII,WAAWF,GACjG,OAAO,MAAQQ,EAAMX,KAAKc,OAAOC,MAAMJ,GAAO,SAKhDX,KAAKc,OAAS,CACbC,MAAOC,IACP9B,OAAQ8B,KAIThB,KAAKiB,UAAYC,EAAS,YAAa,WAAY,SAGnDlB,KAAKmB,cAAgB1C,EAAE2C,mBAAmBC,OAG1CrB,KAAKsB,WAAaC,IAChBrC,OAAOc,KAAKf,QAAQC,QACpBsC,GAAE,SAAUrB,GACZ,OAAOA,EAAEsB,MAAM,MAEfC,GAAE,SAAUvB,GACZ,OAAOA,EAAEsB,MAAM,MAIjBzB,KAAK2B,MAAQ,GAEb3B,KAAKc,OAAOC,MACVa,MAAM5B,KAAKf,QAAQU,YACnBkC,OAAM,GAER7B,KAAKc,OAAO5B,OACV0C,MAAM5B,KAAKf,QAAQW,aACnBiC,OAAM,IAQTC,MAAO,SAAUC,GAEhBtD,EAAEE,IAAIqD,UAAUF,MAAMG,KAAKjC,MAG3BA,KAAKkC,KAAOH,EAGZA,EAAII,GAAG,CAACC,QAAWpC,KAAKqC,QAASrC,MAGjCA,KAAKqC,UAQNC,SAAU,SAAUP,GAEnBtD,EAAEE,IAAIqD,UAAUM,SAASL,KAAKjC,MAG9BA,KAAKuC,oBAGLR,EAAIS,IAAI,CAACJ,QAAWpC,KAAKqC,QAASrC,MAElCA,KAAKkC,KAAO,KAEZO,EAAO,YAAYC,UAWpBC,eAAgB,WAEflE,EAAEE,IAAIqD,UAAUW,eAAeV,KAAKjC,MACpCA,KAAK4C,aAAeH,EAAOzC,KAAK6C,YAAYJ,OAAO,MAOpDF,kBAAmB,aAUnBF,OAAQ,WACP,IAAIS,EAAO9C,KAEX,GAAK8C,EAAKZ,KAAV,CAKA,IAAIa,EAAOD,EAAKnB,MAAMI,KAAI,SAAU5B,GACnC,IAAID,EAAM4C,EAAK7C,IAAIC,IAAIC,GACnBC,EAAM0C,EAAK7C,IAAIG,IAAID,GAGvB,MAAO,CAAC6C,EAAG7C,EAAGsB,MADFqB,EAAKG,SAAS,CAAC/C,EAAKE,IACJ8C,UAAW/C,EAAE,OAKtCgD,EAAOnD,KAAK4C,aAAaQ,UAAU,YACrCL,KAAK,CAAC/C,KAAKkC,KAAKmB,YAAY,SAAUlD,GACtC,OAAOA,KAULmD,EANQH,EAAKI,QAAQC,OAAO,KAC9BC,KAAK,SAAS,SAAUtD,GACxB,MAAO,eAAiBA,KAIFuD,MAAMP,GAG9BA,EAAKQ,OAAOjB,SAGZ1C,KAAK4D,gBAAgBN,EAAaP,KAInCa,gBAAiB,SAAUC,EAAGd,GAC7B,IAAID,EAAO9C,KAKP8D,EAAShB,EAAKZ,KAAK6B,YACnBC,EAAOlB,EAAKZ,KAAK+B,UACrBH,EAASA,EAAOI,IAA0B,EAAtBpB,EAAK7D,QAAQC,OAAa0B,KAAKuD,IAAIH,EAAKxC,EAAGwC,EAAKtC,IAEpE,IAAI0C,EAAOtB,EAAKxB,WAAWyB,GAGvBsB,EAAcvB,EAAKwB,WAAWF,EAAMtB,EAAK7C,IAAII,WAAYyC,EAAK7D,QAAQK,kBACtEiF,EAAezB,EAAKwB,WAAWF,EAAMtB,EAAK7C,IAAIM,YAAauC,EAAK7D,QAAQO,mBAGxEC,EAAcO,KAAKf,QAAQQ,YAC3B,MAAQA,IACXA,EAAcqD,EAAK0B,eAAeH,EAAY,GAAIA,EAAY,GAAIvB,EAAKhC,OAAOC,MAAMa,QAAQtB,SAE7F,IAAIZ,EAAeM,KAAKf,QAAQS,cAAgB6E,EAGhDzB,EAAKhC,OAAOC,MAAM0D,OAAOhF,GACzBqD,EAAKhC,OAAO5B,OAAOuF,OAAO/E,GAQ1B0E,EAAOA,EAAKM,QAAO,SAAUvE,GAC5B,OAAO2D,EAAOa,SAAS7B,EAAKZ,KAAK0C,mBAAmBnG,EAAEgD,MAAMtB,EAAEqB,EAAGrB,EAAEuB,QAEpE,IAAIyB,EAAOU,EAAET,UAAU,sBACrBL,KAAKqB,GAAM,SAAUjE,GACrB,OAAOA,EAAEqB,EAAI,IAAMrB,EAAEuB,KAUvByB,EAAKV,OAAO,uBAAuBoC,aAAazF,SAAS0D,EAAK7D,QAAQG,UACpEqE,KAAK,OAAQX,EAAK7C,IAAIS,KAAKoE,KAAKhC,IAChCW,KAAK,eAAgBX,EAAK7D,QAAQE,SAClCsE,KAAK,iBAAkBX,EAAK7D,QAAQE,SACpCsE,KAAK,KAAK,SAAUtD,GACpB,OAAO2C,EAAKxB,WAAWyD,QAAQjC,EAAKhC,OAAO5B,OAAO4D,EAAK7C,IAAIM,YAAY0B,KAAKa,EAAM3C,QASpF,IAAIoD,EAAQJ,EAAKI,QAAQC,OAAO,KAAKC,KAAK,QAAS,oBAEnDF,EAAMC,OAAO,QAAQC,KAAK,QAAS,kBACjCA,KAAK,aAAa,SAAUtD,GAC5B,MAAO,aAAeA,EAAEqB,EAAI,IAAMrB,EAAEuB,EAAI,OAExC+B,KAAK,KAAK,SAAUtD,GACpB,OAAO2C,EAAKxB,WAAWyD,QAAQjC,EAAKhC,OAAO5B,OAAO0C,QAAQ,OAE1D6B,KAAK,OAAQX,EAAK7C,IAAIS,KAAKoE,KAAKhC,IAChCW,KAAK,eAAgB,KACrBA,KAAK,iBAAkB,KACvBoB,aAAazF,SAAS0D,EAAK7D,QAAQG,UACnCqE,KAAK,eAAgBX,EAAK7D,QAAQE,SAClCsE,KAAK,iBAAkBX,EAAK7D,QAAQE,SACpCsE,KAAK,KAAK,SAAUtD,GACpB,OAAO2C,EAAKxB,WAAWyD,QAAQjC,EAAKhC,OAAO5B,OAAO4D,EAAK7C,IAAIM,YAAY0B,KAAKa,EAAM3C,QAIpEoD,EAAMC,OAAO,QAAQC,KAAK,QAAS,eACjDA,KAAK,aAAa,SAAUtD,GAC5B,MAAO,aAAeA,EAAEqB,EAAI,IAAMrB,EAAEuB,EAAI,OAExC+B,KAAK,KAAK,SAAUtD,GACpB,OAAO2C,EAAKxB,WAAWyD,QAAQjC,EAAK7D,QAAQC,WAE5CuE,KAAK,OAAQ,QACbA,KAAK,SAAU,QACfuB,MAAM,iBAAkBlC,EAAK7D,QAAQY,eAG7B6D,MAAMP,EAAKV,OAAO,qBAC1BN,GAAG,aAAa,SAAUhC,EAAG8E,GAC7BnC,EAAK3B,cAAc+D,UAAUjD,KAAKjC,KAAM8C,EAAM3C,EAAG8E,GACjDnC,EAAK7B,UAAUgB,KAAK,YAAajC,KAAMG,EAAG8E,MAE1C9C,GAAG,YAAY,SAAUhC,EAAG8E,GAC5BnC,EAAK7B,UAAUgB,KAAK,WAAYjC,KAAMG,EAAG8E,GACzCnC,EAAK3B,cAAcgE,SAASlD,KAAKjC,KAAM8C,EAAM3C,EAAG8E,MAEhD9C,GAAG,SAAS,SAAUhC,EAAG8E,GACzBnC,EAAK7B,UAAUgB,KAAK,QAASjC,KAAMG,EAAG8E,MAKxC,IAAItB,EAAOR,EAAKQ,OAEhBA,EAAKlB,OAAO,uBACVoC,aAAazF,SAAS0D,EAAK7D,QAAQG,UACnCqE,KAAK,eAAgB,GACrBA,KAAK,iBAAkB,GACvBA,KAAK,KAAK,SAAUtD,GACpB,OAAO2C,EAAKxB,WAAWyD,QAAQ,MAGjCpB,EAAKkB,aAAazF,SAAS0D,EAAK7D,QAAQG,UACtCsD,UAIH4B,WAAY,SAAUF,EAAMgB,EAASC,GAGpC,IAAIC,EAAUC,EAAOnB,EAAMgB,EAAQN,KAAK9E,OAUxC,OAPI,MAAQsF,EAAQ,KAAIA,EAAQ,GAAK,GACjC,MAAQA,EAAQ,KAAIA,EAAQ,GAAK,GAGjC,MAAQD,EAAY,KAAIC,EAAQ,GAAKD,EAAY,IACjD,MAAQA,EAAY,KAAIC,EAAQ,GAAKD,EAAY,IAE9CC,GAIRrC,SAAU,SAAUuC,GACnB,IAAI/D,EAAQzB,KAAKkC,KAAKuD,mBAAmB,CAACD,EAAM,GAAIA,EAAM,KAC1D,MAAO,CAAC/D,EAAMD,EAAGC,EAAMC,IAGxBgE,WAAY,SAAU3C,GACrB,GAAI,MAAQA,GAAQA,EAAKzC,OAAS,EACjC,MAAO,CAACqF,IAAK,CAAC,EAAG,GAAIxB,IAAK,CAAC,EAAG,IAI/B,IAAIL,EAAS,CAAC,CAAC,IAAK,KAAM,EAAE,KAAM,MAYlC,OAVAf,EAAK6C,SAAQ,SAAUC,GACtB,IAAIrE,EAAIqE,EAAQpE,MAAM,GAClBC,EAAImE,EAAQpE,MAAM,GAEtBqC,EAAO,GAAG,GAAKlD,KAAK+E,IAAI7B,EAAO,GAAG,GAAItC,GACtCsC,EAAO,GAAG,GAAKlD,KAAK+E,IAAI7B,EAAO,GAAG,GAAIpC,GACtCoC,EAAO,GAAG,GAAKlD,KAAKuD,IAAIL,EAAO,GAAG,GAAItC,GACtCsC,EAAO,GAAG,GAAKlD,KAAKuD,IAAIL,EAAO,GAAG,GAAIpC,MAGhC,CAACiE,IAAK7B,EAAO,GAAIK,IAAKL,EAAO,KAGrCU,eAAgB,SAAUsB,EAAMC,EAAIzF,GACnC,IAAI0F,EAAM,IAAIC,MAAM3F,GACpBwF,EAAOA,EAA+B,QAAvB9F,KAAKf,QAAQI,MAAkBuB,KAAKC,KAAKiF,GAAQA,EAAQ,EAIxE,IAHA,IAAII,IACsB,QAAvBlG,KAAKf,QAAQI,MAAkBuB,KAAKC,KAAKkF,GAAMA,GAAMD,GAAQlF,KAAKuD,IAAI7D,EAAS,EAAG,GAE5E2E,EAAI,EAAGA,EAAI3E,IAAU2E,EAC7Be,EAAIf,GAAKa,EAAOb,EAAIiB,EAGrB,OAAOF,GAQR9G,OAAQ,SAAUiH,GACjB,OAAKC,UAAU9F,QAIfN,KAAKf,QAAQC,OAASiH,EACtBnG,KAAKsB,WAAWpC,OAAOiH,GAEhBnG,MANCA,KAAKf,QAAQC,QAStBC,QAAS,SAAUgH,GAClB,OAAKC,UAAU9F,QAGfN,KAAKf,QAAQE,QAAUgH,EAEhBnG,MAJCA,KAAKf,QAAQE,SAOtBC,SAAU,SAAU+G,GACnB,OAAKC,UAAU9F,QAGfN,KAAKf,QAAQG,SAAW+G,EAEjBnG,MAJCA,KAAKf,QAAQG,UAOtBE,iBAAkB,SAAU6G,GAC3B,OAAKC,UAAU9F,QAGfN,KAAKf,QAAQK,iBAAmB6G,EAEzBnG,MAJCA,KAAKf,QAAQK,kBAOtBE,kBAAmB,SAAU2G,GAC5B,OAAKC,UAAU9F,QAGfN,KAAKf,QAAQO,kBAAoB2G,EAE1BnG,MAJCA,KAAKf,QAAQO,mBAOtBG,WAAY,SAAUwG,GACrB,OAAKC,UAAU9F,QAGfN,KAAKf,QAAQU,WAAawG,EAC1BnG,KAAKc,OAAOC,MAAMa,MAAMuE,GAEjBnG,MALCA,KAAKf,QAAQU,YAQtBC,YAAa,SAAUuG,GACtB,OAAKC,UAAU9F,QAGfN,KAAKf,QAAQW,YAAcuG,EAC3BnG,KAAKc,OAAO5B,OAAO0C,MAAMuE,GAElBnG,MALCA,KAAKf,QAAQW,aAQtByG,WAAY,SAAUF,GACrB,OAAKC,UAAU9F,QAGfN,KAAKc,OAAOC,MAAQoF,EAEbnG,MAJCA,KAAKc,OAAOC,OAOrBuF,YAAa,SAAUH,GACtB,OAAKC,UAAU9F,QAGfN,KAAKc,OAAO5B,OAASiH,EAEdnG,MAJCA,KAAKc,OAAO5B,QAOrBgB,IAAK,SAAUiG,GACd,OAAKC,UAAU9F,QAGfN,KAAKC,IAAIC,IAAMiG,EAERnG,MAJCA,KAAKC,IAAIC,KAOlBE,IAAK,SAAU+F,GACd,OAAKC,UAAU9F,QAGfN,KAAKC,IAAIG,IAAM+F,EAERnG,MAJCA,KAAKC,IAAIG,KAOlBC,WAAY,SAAU8F,GACrB,OAAKC,UAAU9F,QAGfN,KAAKC,IAAII,WAAa8F,EAEfnG,MAJCA,KAAKC,IAAII,YAOlBE,YAAa,SAAU4F,GACtB,OAAKC,UAAU9F,QAGfN,KAAKC,IAAIM,YAAc4F,EAEhBnG,MAJCA,KAAKC,IAAIM,aAOlBG,KAAM,SAAUyF,GACf,OAAKC,UAAU9F,QAGfN,KAAKC,IAAIS,KAAOyF,EAETnG,MAJCA,KAAKC,IAAIS,MAOlBqC,KAAM,SAAUoD,GACf,OAAKC,UAAU9F,QAGfN,KAAK2B,MAAS,MAAQwE,EAAKA,EAAI,GAE/BnG,KAAKqC,SAEErC,MANCA,KAAK2B,OAYdT,SAAU,WACT,OAAOlB,KAAKiB,WAGbsF,aAAc,SAAUJ,GACvB,OAAKC,UAAU9F,QAGfN,KAAKmB,cAAiB,MAAQgF,EAAKA,EAAI1H,EAAE2C,mBAAmBC,OAE5DrB,KAAKqC,SAEErC,MANCA,KAAKmB,eAYdqF,WAAY,WACX,IAAI1D,EAAO9C,KAGX,OAAOA,KAAK2B,MAAMI,KAAI,SAAU5B,GAC/B,OAAO1B,EAAEgI,OAAO3D,EAAK7D,QAAQmB,IAAID,GAAI2C,EAAK7D,QAAQiB,IAAIC,QAOxDuG,UAAW,WACV,OAAOjI,EAAEkI,QAAQC,WAAW5G,KAAM,CACjC6G,KAAM,aACNC,YAAarI,EAAEkI,QAAQI,gBAAgB/G,KAAKwG,aAAc,QAO7D/H,EAAE2C,mBAAqB,CAEtB4F,QAAS,SAAU/H,GAId,OADJA,EAAUA,GAAW,IACDgI,iBACnBhI,EAAQgI,eAAiB,SAAS9G,GACjC,IAAI+G,EAAQ/G,EAAEgH,QAAO,SAASC,EAAKC,GAElC,OADAD,GAAOC,EAAKnE,YAEV,GAMH,OAJIjE,EAAQqI,iBACXJ,EAAQjI,EAAQqI,eAAeJ,IAGzBA,IAKT,IAAIF,EAAUvE,EAAO,0BACnBe,OAAO,OACPC,KAAK,QAAS,kBACduB,MAAM,UAAW,SACjBA,MAAM,iBAAkB,QACxBA,MAAM,aAAc,UACpBA,MAAM,WAAY,SAKpB,OAHAgC,EAAQxD,OAAO,OAAOC,KAAK,QAAS,mBAG7B,CACNyB,UAAW,SAAUqC,EAAUxE,GAC9B,IAAIyE,EAAUC,EAAMzH,MAEhB0H,EAAM,KASV,GAPC,MAAQV,EAAQW,SAChBX,EAAQW,QAAQrH,OAAS,GACzB0G,EAAQW,QAAQ,GAAGrH,OAAS,IAE5BoH,EAAMV,EAAQW,QAAQ,GAAG,IAGrBD,EAAL,CAEAV,EAAQhC,MAAM,aAAc,WAAW4C,KAAK3I,EAAQgI,eAAelE,EAAMwE,IAEzE,IAAIM,EAAIH,EAAII,aACRC,EAAIL,EAAIM,YAEZhB,EACEhC,MAAM,MAAaiD,EAAMC,QAAUV,EAAQ,GAAKK,EAAI,GAAM,MAC1D7C,MAAM,OAAciD,EAAME,QAAUX,EAAQ,GAAKO,EAAI,EAAK,QAG7D5C,SAAU,SAAUoC,EAAUxE,GAC7BiE,EACEhC,MAAM,aAAc,UACpB4C,UAMLQ,WAAY,WAGX,MAAO,CACNlD,UAAW,SAAUqC,EAAUxE,GACtBN,EAAOzC,KAAKqI,YAClB5F,OAAO,uBACPgB,KAAK,KAAK,SAAUtD,GACpB,OAAOoH,EAASjG,WAAWyD,QAAQwC,EAAStI,QAAQC,YAGvDiG,SAAU,SAAUoC,EAAUxE,GACrBN,EAAOzC,KAAKqI,YAClB5F,OAAO,uBACPgB,KAAK,KAAK,SAAUtD,GACpB,OAAOoH,EAASjG,WAAWyD,QAAQwC,EAASzG,OAAO5B,OAAOqI,EAAStH,IAAIM,YAAY0B,KAAKsF,EAAUpH,WAOvGmI,YAAa,SAAUrJ,GAOtB,OAHI,OADJA,EAAUA,GAAW,IACDqH,cAAarH,EAAQqH,YAAc,IAGhD,CACNpB,UAAW,SAAUqC,EAAUxE,GACtBN,EAAOzC,KAAKqI,YAClB5F,OAAO,uBACPgB,KAAK,KAAK,SAAUtD,GACpB,OAAOoH,EAASjG,WAAWyD,QAAQwC,EAASzG,OAAO5B,OAAO0C,QAAQ,IAAM,EAAI3C,EAAQqH,kBAGvFnB,SAAU,SAAUoC,EAAUxE,GACrBN,EAAOzC,KAAKqI,YAClB5F,OAAO,uBACPgB,KAAK,KAAK,SAAUtD,GACpB,OAAOoH,EAASjG,WAAWyD,QAAQwC,EAASzG,OAAO5B,OAAOqI,EAAStH,IAAIM,YAAY0B,KAAKsF,EAAUpH,WAOvGoI,SAAU,SAAUtJ,GAKnB,OAFI,OADJA,EAAUA,GAAW,IACDuJ,WAAUvJ,EAAQuJ,SAAW,CAAC/J,EAAE2C,mBAAmBC,SAEhE,CACN6D,UAAW,SAAUqC,EAAUxE,GAC9B,IAAID,EAAO9C,KACXf,EAAQuJ,SAAS5C,SAAQ,SAAUiC,GAClCA,EAAE3C,UAAUjD,KAAKa,EAAMyE,EAAUxE,OAGnCoC,SAAU,SAAUoC,EAAUxE,GAC7B,IAAID,EAAO9C,KACXf,EAAQuJ,SAAS5C,SAAQ,SAAUiC,GAClCA,EAAE1C,SAASlD,KAAKa,EAAMyE,EAAUxE,SAOpC1B,KAAM,WACL,MAAO,CACN6D,UAAW,aAEXC,SAAU,gBAMb1G,EAAEgK,YAAc,SAAUxJ,GACzB,OAAO,IAAIR,EAAEC,YAAYO"}